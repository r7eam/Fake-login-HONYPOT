# Logrotate configuration for honeypot data files
#
# Install on host system:
#   sudo cp logrotate.conf /etc/logrotate.d/honeypot
#   sudo chmod 644 /etc/logrotate.d/honeypot
#
# Test configuration:
#   sudo logrotate -d /etc/logrotate.d/honeypot
#
# Force rotation (for testing):
#   sudo logrotate -f /etc/logrotate.d/honeypot

/data/honeypot_events.jsonl /data/honeypot_enriched.jsonl {
    # Rotate daily or when file reaches 100MB
    daily
    size 100M
    
    # Keep 30 days of logs
    rotate 30
    
    # Compress old logs with gzip
    compress
    delaycompress
    
    # Don't error if log file is missing
    missingok
    
    # Don't rotate empty files
    notifempty
    
    # Create new log file with specific permissions
    create 0640 honeypot honeypot
    
    # Archive format: honeypot_events-YYYYMMDD.jsonl.gz
    dateext
    dateformat -%Y%m%d
    
    # Don't mail logs
    nomail
    
    # Run post-rotation script
    postrotate
        # Signal enrichment worker to reopen log files
        if [ -f /var/run/enrich-worker.pid ]; then
            kill -HUP $(cat /var/run/enrich-worker.pid) 2>/dev/null || true
        fi
        
        # Optionally upload to S3 or archive storage
        # aws s3 cp /data/honeypot_events-*.jsonl.gz s3://honeypot-archives/ || true
    endscript
    
    # Shared scripts run once after all logs rotated
    sharedscripts
}

# Rotate error logs separately
/data/enrich_error.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 0640 honeypot honeypot
    dateext
}
